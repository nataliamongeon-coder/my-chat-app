<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„ç§äººé€šè®¯å·¥å…·</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; height: 100vh; display: flex; flex-direction: column; }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        
        .msg-item { display: flex; flex-direction: column; max-width: 85%; align-self: flex-start; }
        .msg-header { font-size: 11px; color: #888; margin-bottom: 3px; font-weight: bold; }
        .msg-content { background: white; padding: 10px 14px; border-radius: 12px; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-break: break-all; }
        .msg-img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }

        .input-area { background: white; padding: 10px 15px; display: flex; align-items: center; border-top: 1px solid #ddd; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        input[type="text"] { flex: 1; border: 1px solid #ddd; padding: 10px 15px; border-radius: 20px; font-size: 16px; outline: none; }
        .icon-btn { font-size: 24px; margin-right: 12px; cursor: pointer; }
        #send-btn { background: #07c160; color: white; border: none; padding: 8px 18px; border-radius: 18px; margin-left: 10px; font-weight: bold; }
    </style>
</head>
<body>

<div id="chat-box"></div>

<div class="input-area">
    <label for="file-input" class="icon-btn">ğŸ–¼ï¸</label>
    <input type="file" id="file-input" style="display:none" accept="image/*">
    <input type="text" id="msg-input" placeholder="å†™æ¶ˆæ¯..." autocomplete="off">
    <button id="send-btn">å‘é€</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const chatBox = document.getElementById('chat-box');
    const input = document.getElementById('msg-input');
    const fileInput = document.getElementById('file-input');
    const sendBtn = document.getElementById('send-btn');

    let myName = localStorage.getItem('chat-nick') || prompt("è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼š");
    if (myName) localStorage.setItem('chat-nick', myName);
    else myName = "è®¿å®¢" + Math.floor(Math.random()*1000);

    // æ¸²æŸ“æ¶ˆæ¯åˆ°ç•Œé¢
    function renderMsg(data) {
        const item = document.createElement('div');
        item.className = 'msg-item';
        let content = data.type === 'text' ? 
            `<div class="msg-content">${data.content}</div>` : 
            `<div class="msg-content" style="padding:4px"><img src="${data.content}" class="msg-img"></div>`;
        
        item.innerHTML = `<div class="msg-header">${data.user} Â· ${data.time}</div>${content}`;
        chatBox.appendChild(item);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // å‘é€é€»è¾‘
    function sendText() {
        if (input.value.trim()) {
            socket.emit('send message', {
                user: myName, type: 'text', content: input.value,
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
            });
            input.value = '';
        }
    }

    fileInput.onchange = function() {
        if (!this.files[0]) return;
        const fd = new FormData();
        fd.append('chatImage', this.files[0]);
        fetch('/upload', { method: 'POST', body: fd })
            .then(r => r.json())
            .then(d => {
                if (d.url) socket.emit('send message', {
                    user: myName, type: 'image', content: d.url,
                    time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
                });
            }).catch(() => alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'));
        this.value = '';
    };

    sendBtn.onclick = sendText;
    input.onkeypress = (e) => { if(e.key === 'Enter') sendText(); };

    // ç›‘å¬å†å²è®°å½•å’Œæ–°æ¶ˆæ¯
    socket.on('history', (list) => list.forEach(renderMsg));
    socket.on('receive message', renderMsg);
</script>
</body>
</html>